<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Blockchain L1, L2 and DeFi Research">
    <title>Lazer 1 Research | Liquidation math on a DeFi lending protocol: how much to liquidate?</title>
    
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@lazer_1_xyz">
<meta name="twitter:creator" content="@lazer_1_xyz">

<meta name="twitter:title" content="Lazer 1 Research | Liquidation math on a DeFi lending protocol: how much to liquidate?">
<meta property="og:title" content="Lazer 1 Research | Liquidation math on a DeFi lending protocol: how much to liquidate?">


<meta property="og:type" content="website">

<meta property="og:url" content="https://lazer1.xyz/blog/liquidation-math-on-a-defi-lending-protocol-how-much-to-liquidate/" />

<meta property="og:image" content="https://lazer1.xyz/logo_black.svg">
<meta name="twitter:image" content="https://lazer1.xyz/logo_black.svg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Martian+Mono:wght@100..800&family=Kanit:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://lazer1.xyz/style.css?h=f96266b8aba3614658d7">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.19/dist/katex.min.css" integrity="sha384-7lU0muIg/i1plk7MgygDUp3/bNRA65orrBub4/OSWHECgwEsY83HaS1x3bljA/XV" crossorigin="anonymous">

<!-- The loading of KaTeX is deferred to speed up page rendering -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.19/dist/katex.min.js" integrity="sha384-RdymN7NRJ+XoyeRY4185zXaxq9QWOOx3O7beyyrRK4KQZrPlCDQQpCu95FoCGPAE" crossorigin="anonymous"></script>

<!-- To automatically render math in text elements, include the auto-render extension: -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.19/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
</head>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
    });
</script>


    
    
    
    <!-- Paste this right before your closing </head> tag -->
    <script type="text/javascript">
    (function (f, b) { if (!b.__SV) { var e, g, i, h; window.mixpanel = b; b._i = []; b.init = function (e, f, c) { function g(a, d) { var b = d.split("."); 2 == b.length && ((a = a[b[0]]), (d = b[1])); a[d] = function () { a.push([d].concat(Array.prototype.slice.call(arguments, 0))); }; } var a = b; "undefined" !== typeof c ? (a = b[c] = []) : (c = "mixpanel"); a.people = a.people || []; a.toString = function (a) { var d = "mixpanel"; "mixpanel" !== c && (d += "." + c); a || (d += " (stub)"); return d; }; a.people.toString = function () { return a.toString(1) + ".people (stub)"; }; i = "disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split( " "); for (h = 0; h < i.length; h++) g(a, i[h]); var j = "set set_once union unset remove delete".split(" "); a.get_group = function () { function b(c) { d[c] = function () { call2_args = arguments; call2 = [c].concat(Array.prototype.slice.call(call2_args, 0)); a.push([e, call2]); }; } for ( var d = {}, e = ["get_group"].concat( Array.prototype.slice.call(arguments, 0)), c = 0; c < j.length; c++) b(j[c]); return d; }; b._i.push([e, f, c]); }; b.__SV = 1.2; e = f.createElement("script"); e.type = "text/javascript"; e.async = !0; e.src = "undefined" !== typeof MIXPANEL_CUSTOM_LIB_URL ? MIXPANEL_CUSTOM_LIB_URL : "file:" === f.location.protocol && "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//) ? "https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js" : "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js"; g = f.getElementsByTagName("script")[0]; g.parentNode.insertBefore(e, g); } })(document, window.mixpanel || []);
    window.mixpanel.init("b477cb68b3e8754f05577f53e8dc3375", {
        debug: true,
        track_pageview: true,
        persistence: "localStorage",
    });
  </script>
</head>
<body>
    
<header class="space">
    <div style="width: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
        <img class="logo-white" src="https://lazer1.xyz/logo_white.svg" width="426.5" height="123.5" alt="Lazer 1 Research">
        <img class="logo-black" src="https://lazer1.xyz/logo_black.svg" width="426.5" height="123.5" alt="Lazer 1 Research">
        <h2>RESEARCH LOG</h2>
    </div>
    <a href="https:&#x2F;&#x2F;lazer1.xyz">&LeftArrow; Home</a>
</header>

    
<main>
    <h1>Liquidation math on a DeFi lending protocol: how much to liquidate?</h1>
    
    <p class="secondary" style="display: inline">4 December, 2024</p>
        
            <p class="secondary" style="display: inline">|</p>
        
    
    
    <p class="secondary" style="display: inline">
        Written by
        
            <a href="https://github.com/9oelm" target="_blank">9oelm</a>
        
    </p>
    
    
    <h2>Table of Contents</h2>
    <ul>
        
            <li>
                <a href="https://lazer1.xyz/blog/liquidation-math-on-a-defi-lending-protocol-how-much-to-liquidate/#borrow-factor">Borrow factor</a>
                
            </li>
        
            <li>
                <a href="https://lazer1.xyz/blog/liquidation-math-on-a-defi-lending-protocol-how-much-to-liquidate/#collateral-factor-and-collateralization-ratio">Collateral factor and collateralization ratio</a>
                
            </li>
        
            <li>
                <a href="https://lazer1.xyz/blog/liquidation-math-on-a-defi-lending-protocol-how-much-to-liquidate/#how-much-to-pay-for-liquidation">How much to pay for liquidation</a>
                
                    <ul>
                        
                            <li>
                                <a href="https://lazer1.xyz/blog/liquidation-math-on-a-defi-lending-protocol-how-much-to-liquidate/#1-text-hf-ge-1">1. $\text{HF} \ge 1$</a>
                                
                            </li>
                        
                            <li>
                                <a href="https://lazer1.xyz/blog/liquidation-math-on-a-defi-lending-protocol-how-much-to-liquidate/#2-text-hf-le-1-and-rv-text-repaid-asset-min-rv-text-repaid-asset-min-dv-text-repaid-asset-frac-cv-text-liquidated-asset-1-lf-text-liquidated-asset">2. $\text{HF} \le 1$ and $RV_{\text{repaid asset}} = min(RV_{\text{repaid asset}}, min(DV_{\text{repaid asset}}, \frac{CV_{\text{liquidated asset}}}{1 + LF_{\text{liquidated asset}}}))$</a>
                                
                            </li>
                        
                            <li>
                                <a href="https://lazer1.xyz/blog/liquidation-math-on-a-defi-lending-protocol-how-much-to-liquidate/#3-text-hf-le-1-and-text-final-repaid-amount-text-repaid-asset-frac-cv-text-liquidated-asset-1-lf-text-liquidated-asset-min-rv-text-repaid-asset-min-dv-text-repaid-asset-frac-cv-text-liquidated-asset-1-lf-text-liquidated-asset">3. $\text{HF} \le 1$ and $\text{Final Repaid Amount}_{\text{repaid asset}} = \frac{CV_{\text{liquidated asset}}}{1 + LF_{\text{liquidated asset}}} = min(RV_{\text{repaid asset}}, min(DV_{\text{repaid asset}}, \frac{CV_{\text{liquidated asset}}}{1 + LF_{\text{liquidated asset}}})$</a>
                                
                            </li>
                        
                            <li>
                                <a href="https://lazer1.xyz/blog/liquidation-math-on-a-defi-lending-protocol-how-much-to-liquidate/#4-dv-text-repaid-asset-min-rv-text-repaid-asset-min-dv-text-repaid-asset-frac-cv-text-liquidated-asset-1-lf-text-liquidated-asset">4. $DV_{\text{repaid asset}} = min(RV_{\text{repaid asset}}, min(DV_{\text{repaid asset}}, \frac{CV_{\text{liquidated asset}}}{1 + LF_{\text{liquidated asset}}})$</a>
                                
                            </li>
                        
                    </ul>
                
            </li>
        
            <li>
                <a href="https://lazer1.xyz/blog/liquidation-math-on-a-defi-lending-protocol-how-much-to-liquidate/#describing-the-behavior-in-code">Describing the behavior in code</a>
                
            </li>
        
    </ul>
    
    <div class="space"></div>
    <p><strong>Liquidation in DeFi lending</strong> occurs when a borrower's loan-to-value (LTV) ratio exceeds the protocol's liquidation threshold, either due to a drop in collateral value or an increase in the borrowed asset's value. This mechanism protects the platform's solvency by ensuring loans remain adequately backed. </p>
<p>When the threshold is breached, smart contracts allow anyone to trigger liquidation, repaying part of the debt and receiving collateral plus a bonus as an incentive. This process mitigates insolvency risks caused by market volatility.</p>
<p>But for this specific post, let's talk about <strong><em>how to calculate the exact amount to be repaid in liquidation</em></strong>. I'm simply writing about this because no one on the Internet is talking about this, but this is much needed information when you are configuring your own liquidator or lending protocol. Otherwise, you will have to 'brute force' the amount to liquidate, which is definitely something that you don't want.</p>
<h2 id="borrow-factor">Borrow factor</h2>
<p>Review these docs:</p>
<ul>
<li><a href="https://docs.kamino.finance/products/borrow-lend/position-risk-and-liquidations/borrow-factors">Kamino Finance</a></li>
<li><a href="https://docs-v1.euler.finance/app/ui/lending-and-borrowing-example#borrowing">Euler Finance</a></li>
</ul>
<p>A borrow factor is a risk-adjusted borrowing capacity ratio assigned to each asset. We follow Euler Finance's convention: it is the percentage of the asset that can be borrowed against a certain amount of collateral. It saves a room for price fluctuations in case of liquidation. Essentially, it has the same goal as the <a href="https://docs.aave.com/risk/asset-risk/risk-parameters#liquidation-threshold">liquidation threshold</a> in some of the other protocols, which is to protect borrowers from sharp price fluctuations and potential liquidations. </p>
<p>For example, given this table below:</p>
<table><thead><tr><th></th><th>TON</th><th>USDT</th></tr></thead><tbody>
<tr><td>Collateral factor</td><td>90%</td><td>90%</td></tr>
<tr><td>Borrow factor</td><td>70%</td><td>100%</td></tr>
<tr><td>Price</td><td>5 USD</td><td>1 USD</td></tr>
</tbody></table>
<p>Deposit USDT, borrow TON:</p>
<ol>
<li>You deposit 100 USDT = 100 USD</li>
<li>When you want to borrow TON, you can only borrow (original value of collateral) x (collateral factor of the collateral) x (borrow factor of the borrowing asset) = 100 x 0.9 x 0.7 = 63 USD.</li>
</ol>
<p>Deposit TON, borrow USDT:</p>
<ol>
<li>You deposit 20 TON = 100 USD</li>
<li>When you want to borrow USDT, you can only borrow (original value of collateral) x (collateral factor of the collateral) x (borrow factor of the borrowing asset) = 100 x 0.9 x 1 = 90 USD.</li>
</ol>
<p>Generally speaking, the borrow factor helps manage risk within the protocol by accounting for volatility. Lower borrow factors are assigned to more volatile assets, allowing less borrowing against them, while more stable assets may have higher borrow factors.</p>
<h2 id="collateral-factor-and-collateralization-ratio">Collateral factor and collateralization ratio</h2>
<p>When a user is withdrawing or borrowing, the protocol uses the collateral factor as well as borrow factor to check if the user is still overcollateralized after withdrawal or borrowing. The collateral factor on other protocols is also sometimes called <a href="https://aave.com/docs/concepts/risks#collateral-risk">&quot;LTV&quot;, which stands for loan-to-value</a>. </p>
<p>Borrow and collateral factors work together to represent collateralization of a user, which is called &quot;collateralization ratio&quot;:</p>
<p>$$
\text{Collateralization ratio} = \frac{\sum (\text{Collateral Factor}_i \times \text{Collateral Value in USD}_i)}{\sum (\frac{\text{Borrowing Value in USD}_i}{\text{Borrow Factor}_i })}
$$</p>
<p>where $0 \leq \text{Collateral factor} \leq 1$ and $0 \leq \text{Borrow factor} \leq 1$.</p>
<p>For example, given the following table:</p>
<table><thead><tr><th></th><th>TON</th><th>USDT</th></tr></thead><tbody>
<tr><td>Collateral factor</td><td>90%</td><td>90%</td></tr>
<tr><td>Borrow factor</td><td>70%</td><td>100%</td></tr>
<tr><td>Price</td><td>5 USD</td><td>1 USD</td></tr>
<tr><td>Deposited amount</td><td>5 USD</td><td>1 USD</td></tr>
<tr><td>Borrowed amount</td><td>2 USD</td><td>0.3 USD</td></tr>
</tbody></table>
<p>The collateralization ratio would be:</p>
<p>$$
\text{Collateralization ratio} = \frac{(0.9 \times 5) + (0.9 \times 1)}{\frac{2}{0.7} + \frac{0.3}{1.0}} = \frac{(4.5) + (0.9)}{\frac{2}{0.7} + 0.3} = \frac{5.4}{2.857 + 0.3} = \frac{5.4}{3.157} = 1.71... &gt; 0
$$</p>
<p>In this case, the collateralization ratio is bigger than 0, so this can be the state of the user after user has successfully withdrawn or borrowed some amount from a fully functional protocol. The user needs to keep the collateralization ratio above 1.</p>
<p>For liquidation, the <a href="https://aave.com/help/borrowing/liquidations"><em>health factor</em></a> is calculated instead.</p>
<p>$$
\text{Health factor} = \frac{\sum (\text{Collateral Factor}_i \times \text{Collateral Value in USD}_i)}{\sum \text{Borrowing Value in USD}_i}
$$</p>
<p>The health factor is always bigger than or equal to the collateralization ratio because we take the borrow factor out, which always deflates the result of the equation. When they are equal, they will always be at the positive infinity.</p>
<p>Using the information from the table above, the health factor would be:</p>
<p>$$
\text{Health factor} = \frac{(0.9 \times 5) + (0.9 \times 1)}{2 + 0.3} = \frac{(4.5) + (0.9)}{2.3} = \frac{5.4}{2.3} = 2.347
$$</p>
<p>As it can be seen, the health factor is greater than the collateralization ratio. The difference between the health factor and the collateralization ratio is a buffer for the borrowers. When the health factor goes below 1, anyone can liquidate that user and make it back to 1 or closer to 1.</p>
<h2 id="how-much-to-pay-for-liquidation">How much to pay for liquidation</h2>
<p>The liquidation must happen before the health factor drops 'too much'. What would be 'too much'?: When the value of the collateral is so little that the health factor cannot be recovered back to 1 even after being liquidated. How do we derive the equation? We can use the same health factor equation we have above.</p>
<p>Let's give an example using the variables below, and let's say we are repaying USDT debt and taking away TON collateral during liquidation:</p>
<table><thead><tr><th></th><th>TON</th><th>USDT</th></tr></thead><tbody>
<tr><td>Collateral factor (liquidation threshold)</td><td>80%</td><td>85%</td></tr>
<tr><td>Deposited amount in USD</td><td>5.4 USD</td><td>0.1 USD</td></tr>
<tr><td>Borrowed amount in USD</td><td>0.1 USD</td><td>5 USD</td></tr>
<tr><td>Liquidation bonus</td><td>6%</td><td>7%</td></tr>
</tbody></table>
<p>Let's expand:</p>
<p>$$
\text{Health factor} = \frac{\sum (\text{Collateral Factor}_i \times \text{Collateral Value in USD}_i)}{\sum \text{Borrowing Value in USD}_i}
$$</p>
<p>into</p>
<p>$$
\text{HF}_{\text{after liquidation}} = \frac{CF_{TON} \times (CV_{TON} - RV_{USDT}(1 + LF_{TON})) + CF_{USDT} \times CV_{USDT}}{DV_{TON} + DV_{USDT} - RV_{USDT}}
$$</p>
<p>where</p>
<ul>
<li>$\text{HF}_{\text{after liquidation}}$ is the health factor <em>after</em> liquidation takes place.</li>
<li>$\text{CF}_{asset}$ is the collateral factor of an $asset$.</li>
<li>$\text{CV}_{asset}$ is the value of an $asset$ deposited as a collateral in USD.</li>
<li>$\text{RV}_{asset}$ is the value of repayment on the debt of an $asset$ in USD.</li>
<li>$\text{DV}_{asset}$ is the value of the debt of an $asset$ in USD.</li>
<li>$\text{LF}_{asset}$ is the liquidation bonus factor of an $asset$.</li>
</ul>
<p>Notice that the equation is just an equation for the health factor in the post-liquidation state. $CF_{TON} \times (CV_{TON} - RV_{USDT}(1 + LF_{TON}))$ represents the discounted collateral left after a part of TON collateral including the liquidation bonus is captured in exchange for the USDT debt repayment by the liquidator. $CF_{USDT} \times CV_{USDT}$ represents the discounted USDT collateral. $DV_{TON} + DV_{USDT} - RV_{USDT}$ represents total debt after the USDT debt repayment.</p>
<p>Let's rearrange the equation so we can solve for $\text{RV}_{USDT}$:</p>
<p>$$
\text{HF}_{\text{after liquidation}} = \frac{CF_{TON} \times (CV_{TON} - RV_{USDT}(1 + LF_{TON})) + CF_{USDT} \times CV_{USDT}}{DV_{TON} + DV_{USDT} - RV_{USDT}}
$$</p>
<p>$$
\implies \text{HF}_{\text{after liquidation}}(DV_{TON}) + \text{HF}_{\text{after liquidation}}(DV_{USDT}) - \text{HF}_{\text{after liquidation}}(RV_{USDT})
$$</p>
<p>$$
= (CF_{TON})(CV_{TON}) - (RV_{USDT})(CF_{TON})(1 + LF_{TON})) + (CF_{USDT})(CV_{USDT})
$$</p>
<p>$$
\implies (RV_{USDT})(CF_{TON})(1 + LF_{TON})) - \text{HF}_{\text{after liquidation}}(RV_{USDT}
$$</p>
<p>$$
= -\text{HF}_{\text{after liquidation}}(DV_{TON}) -\text{HF}_{\text{after liquidation}}(DV_{USDT}) + (CF_{TON})(CV_{TON}) + (CF_{USDT})(CV_{USDT})
$$</p>
<p>$$
\implies (RV_{USDT})((CF_{TON})(1 + LF_{TON})) - \text{HF}_{\text{after liquidation}})
$$</p>
<p>$$
= -\text{HF}_{\text{after liquidation}}(DV_{TON} + DV_{USDT}) + \sum\limits_{i}{(CF_i \times CV_i)}
$$</p>
<p>$$
\implies (RV_{USDT})((CF_{TON})(1 + LF_{TON})) - \text{HF}_{\text{after liquidation}})
$$</p>
<p>$$
= -\text{HF}_{\text{after liquidation}}(\sum\limits_{i}{DV_i}) + \sum\limits_{i}{(CF_i \times CV_i)}
$$</p>
<p>$$
\implies RV_{USDT} = \frac{-\text{HF}_{\text{after liquidation}}(\sum\limits_{i}{DV_i}) + \sum\limits_{i}{(CF_i \times CV_i)}}{((CF_{TON})(1 + LF_{TON})) - \text{HF}_{\text{after liquidation}}}
$$</p>
<p>Now that we have the equation ready, substitute the variables. We know that:</p>
<p>$$
\text{HF}_{\text{after liquidation}} \le 1
$$</p>
<p>, so let's substitute:</p>
<p>$$
\text{HF}_{\text{after liquidation}} = 1
$$</p>
<p>in this equation below:</p>
<p>$$
RV_{USDT} = \frac{-(1)(5 + 0.1) + (0.8 \times 5.4 + 0.85 \times 0.1)}{((0.8)(1 + 0.06)) - 1}
$$</p>
<p>We can run this Python script to confirm the result:</p>
<pre data-lang="py" style="background-color:#2b303b;color:#c0c5ce;" class="language-py "><code class="language-py" data-lang="py"><span style="color:#bf616a;">RV_USDT_NUMERATOR </span><span>= (-</span><span style="color:#d08770;">1 </span><span>* (</span><span style="color:#d08770;">0.1 </span><span>+ </span><span style="color:#d08770;">5</span><span>) + (</span><span style="color:#d08770;">0.8 </span><span>* </span><span style="color:#d08770;">5.4 </span><span>+ </span><span style="color:#d08770;">0.85 </span><span>* </span><span style="color:#d08770;">0.1</span><span>))
</span><span style="color:#bf616a;">RV_USDT_DENOMINATOR </span><span>= ((</span><span style="color:#d08770;">0.8</span><span>) * (</span><span style="color:#d08770;">1 </span><span>+ </span><span style="color:#d08770;">0.06</span><span>) - </span><span style="color:#d08770;">1</span><span>)
</span><span style="color:#bf616a;">RV_USDT </span><span>= </span><span style="color:#bf616a;">RV_USDT_NUMERATOR </span><span>/ </span><span style="color:#bf616a;">RV_USDT_DENOMINATOR
</span><span>
</span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#bf616a;">RV_USDT_NUMERATOR</span><span>)
</span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#bf616a;">RV_USDT_DENOMINATOR</span><span>)
</span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#bf616a;">RV_USDT</span><span>)
</span><span>
</span><span style="color:#bf616a;">HF_CHECK_NUMERATOR </span><span>= </span><span style="color:#d08770;">0.8 </span><span>* (</span><span style="color:#d08770;">5.4 </span><span>- </span><span style="color:#bf616a;">RV_USDT </span><span>* (</span><span style="color:#d08770;">1 </span><span>+ </span><span style="color:#d08770;">0.06</span><span>)) + </span><span style="color:#d08770;">0.85 </span><span>* </span><span style="color:#d08770;">0.1
</span><span style="color:#bf616a;">HF_CHECK_DENOMINATOR </span><span>= </span><span style="color:#d08770;">5.1 </span><span>- </span><span style="color:#bf616a;">RV_USDT
</span><span style="color:#bf616a;">HF </span><span>= </span><span style="color:#bf616a;">HF_CHECK_NUMERATOR</span><span>/</span><span style="color:#bf616a;">HF_CHECK_DENOMINATOR
</span><span>
</span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#bf616a;">HF_CHECK_NUMERATOR</span><span>)
</span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#bf616a;">HF_CHECK_DENOMINATOR</span><span>)
</span><span style="color:#96b5b4;">print</span><span>(</span><span style="color:#bf616a;">HF</span><span>)
</span></code></pre>
<p>The console will print:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">-0.6949999999999994 </span><span style="color:#65737e;"># RV_USDT_NUMERATOR
</span><span style="color:#bf616a;">-0.1519999999999999 </span><span style="color:#65737e;"># RV_USDT_DENOMINATOR
</span><span style="color:#bf616a;">4.57236842105263 </span><span style="color:#65737e;"># RV_USDT
</span><span style="color:#bf616a;">0.5276315789473698 </span><span style="color:#65737e;"># HF_CHECK_NUMERATOR
</span><span style="color:#bf616a;">0.5276315789473696 </span><span style="color:#65737e;"># HF_CHECK_DENOMINATOR
</span><span style="color:#bf616a;">1.0000000000000004 </span><span style="color:#65737e;"># HF
</span></code></pre>
<p>Disregarding the floating point number errors, we can confirm that we deduced the correct $RV_{USDT}$.</p>
<p>We can now generalize the equation further, from:</p>
<p>$$
RV_{USDT} = \frac{-\text{HF}_{\text{after liquidation}}(\sum\limits_{i}{DV_i}) + \sum\limits_{i}{(CF_i \times CV_i)}}{((CF_{TON})(1 + LF_{TON})) - \text{HF}_{\text{after liquidation}}}
$$</p>
<p>to:</p>
<p>$$
RV_{\text{repaid asset}} = \frac{-\text{HF}_{\text{after liquidation}}(\sum\limits_{i}{DV_i}) + \sum\limits_{i}{(CF_i \times CV_i)}}{(CF_{\text{liquidated asset}})(1 + LF_{\text{liquidated asset}}) - \text{HF}_{\text{after liquidation}}}
$$</p>
<p>However, in some cases where more than two assets are borrowed or deposited as collaterals, $RV_{\text{repaid asset}}$ can exceed $DV_{\text{repaid asset}}$ or $CV_{\text{liquidated asset}}$. In either case, repayment is not valid because repayment amount must be smaller than the debt and must be smaller than the captured collateral amount plus liquidation bonus in order for the liquidation to work.</p>
<p>In such cases, $\text{Final Repaid Amount}_{\text{repaid asset}}$ needs to be reduced down to $min(RV_{\text{repaid asset}}, min(DV_{\text{repaid asset}}, \frac{CV_{\text{liquidated asset}}}{1 + LF_{\text{liquidated asset}}}))$.</p>
<p>Below, we review all of the different possibilities for liquidation. We use $\text{USDT} = \text{repaid asset}$, and $\text{TON} = \text{liquidated asset}$.</p>
<h4 id="1-text-hf-ge-1">1. $\text{HF} \ge 1$</h4>
<table><thead><tr><th></th><th>TON</th><th>USDT</th></tr></thead><tbody>
<tr><td>Collateral factor (liquidation threshold)</td><td>80%</td><td>85%</td></tr>
<tr><td>Deposited amount in USD</td><td>5.4 USD</td><td>0.1 USD</td></tr>
<tr><td>Borrowed amount in USD</td><td>0.1 USD</td><td>0 USD</td></tr>
<tr><td>Liquidation bonus</td><td>6%</td><td>7%</td></tr>
</tbody></table>
<p>In this case, there can't be a liquidation on this account, because the user's position is healthy:</p>
<p>$$
\text{HF} = \frac{0.8 \times 5.4 + 0.85 \times 0.1}{0.1} \ge 1
$$</p>
<h4 id="2-text-hf-le-1-and-rv-text-repaid-asset-min-rv-text-repaid-asset-min-dv-text-repaid-asset-frac-cv-text-liquidated-asset-1-lf-text-liquidated-asset">2. $\text{HF} \le 1$ and $RV_{\text{repaid asset}} = min(RV_{\text{repaid asset}}, min(DV_{\text{repaid asset}}, \frac{CV_{\text{liquidated asset}}}{1 + LF_{\text{liquidated asset}}}))$</h4>
<table><thead><tr><th></th><th>TON</th><th>USDT</th></tr></thead><tbody>
<tr><td>Collateral factor (liquidation threshold)</td><td>80%</td><td>85%</td></tr>
<tr><td>Deposited amount in USD</td><td>5.4 USD</td><td>0.1 USD</td></tr>
<tr><td>Borrowed amount in USD</td><td>0.1 USD</td><td>5 USD</td></tr>
<tr><td>Liquidation bonus</td><td>6%</td><td>7%</td></tr>
</tbody></table>
<p>This is the example we used previously. HF is smaller than 1:</p>
<p>$$
\text{HF} = \frac{0.8 \times 5.4 + 0.85 \times 0.1}{0.1 + 5} = \frac{4.405}{5.1} \le 1
$$</p>
<p>and $RV_{\text{repaid asset}} = min(RV_{\text{repaid asset}}, min(DV_{\text{repaid asset}}, \frac{CV_{\text{liquidated asset}}}{1 + LF_{\text{liquidated asset}}})$:</p>
<p>$$
RV_{\text{repaid asset}} = \frac{-\text{HF}_{\text{after liquidation}}(\sum\limits_{i}{DV_i}) + \sum\limits_{i}{(CF_i \times CV_i)}}{((CF_{\text{liquidated asset}})(1 + LF_{\text{liquidated asset}})) - \text{HF}_{\text{after liquidation}}}
$$</p>
<p>$$
\implies RV_{\text{USDT}} = \frac{-(1)(5 + 0.1) + (0.8 \times 5.4 + 0.85 \times 0.1)}{((0.8)(1 + 0.06)) - 1}
$$</p>
<p>$$
\implies RV_{\text{USDT}} = 4.57236842105263...
$$</p>
<h4 id="3-text-hf-le-1-and-text-final-repaid-amount-text-repaid-asset-frac-cv-text-liquidated-asset-1-lf-text-liquidated-asset-min-rv-text-repaid-asset-min-dv-text-repaid-asset-frac-cv-text-liquidated-asset-1-lf-text-liquidated-asset">3. $\text{HF} \le 1$ and $\text{Final Repaid Amount}_{\text{repaid asset}} = \frac{CV_{\text{liquidated asset}}}{1 + LF_{\text{liquidated asset}}} = min(RV_{\text{repaid asset}}, min(DV_{\text{repaid asset}}, \frac{CV_{\text{liquidated asset}}}{1 + LF_{\text{liquidated asset}}})$</h4>
<p>Put simply, this is when the amount of collateral to be liquidated isn't enough to bring HF back to 1, because the user has multiple collaterals.</p>
<table><thead><tr><th></th><th>TON</th><th>USDT</th></tr></thead><tbody>
<tr><td>Collateral factor (liquidation threshold)</td><td>80%</td><td>85%</td></tr>
<tr><td>Deposited amount in USD</td><td>3 USD</td><td>2.5 USD</td></tr>
<tr><td>Borrowed amount in USD</td><td>0.1 USD</td><td>5 USD</td></tr>
<tr><td>Liquidation bonus</td><td>6%</td><td>7%</td></tr>
</tbody></table>
<p>Calculate HF first:</p>
<p>$$
\text{HF} = \frac{0.8 \times 3 + 0.85 \times 2.5}{0.1 + 5} = \frac{4.525}{5.1} \le 1
$$</p>
<p>$$
RV_{\text{USDT}} = \frac{-(1)(5 + 0.1) + (0.8 \times 3 + 0.85 \times 2.5)}{((0.8)(1 + 0.06)) - 1} = 3.7828947368421026...
$$</p>
<p>$$
3.7828947368421026... \ge CV_{TON} \because CV_{TON} = 3
$$</p>
<p>$$
3.7828947368421026... \le DV_{USDT} \because DV_{USDT} = 5
$$</p>
<p>$$
\implies \text{Final Repaid Amount}_{USDT} = \frac{CV_{\text{TON}}}{1 + LF_{\text{TON}}} = min(RV_{\text{repaid asset}}, min(DV_{\text{repaid asset}}, \frac{CV_{\text{TON}}}{1 + LF_{\text{TON}}})
$$</p>
<p>Therefore, we can only repay $\frac{3}{1 + LF_{\text{TON}}} = \frac{3}{1.06} = 2.830188679....$ in this scenario. HF will not be fully restored back to 1. The denominator exists to account for the liquidation bonus, so that we can get 3 USD as the value of captured collateral plus liquidation bonus, which is the maximum we can get from the deposited USDT collateral. But liquidation should still run regardless.</p>
<p>Here's $\text{HF}_{\text{after liquidation}}$:</p>
<p>$$
\text{HF}_{\text{after liquidation}} = \frac{CF_{TON} \times (CV_{TON} - (\text{Final Repaid Amount}_{USDT})(1 + LF_{\text{TON}})) + CF_{USDT} \times CV_{USDT}}{DV_{TON} + DV_{USDT} - \text{Final Repaid Amount}_{USDT}}
$$</p>
<p>$$
= \frac{0 + CF_{USDT} \times CV_{USDT}}{DV_{TON} + DV_{USDT} - \text{Final Repaid Amount}_{USDT}}
$$</p>
<p>$$
= \frac{0 + 2.5 \times 0.85}{5.1 - 2.5} = \frac{2.125}{2.6} = 0.81730769....
$$</p>
<p>Notice that we will need to liquidate the other collateral to fully recover the health factor back to 1.</p>
<h4 id="4-dv-text-repaid-asset-min-rv-text-repaid-asset-min-dv-text-repaid-asset-frac-cv-text-liquidated-asset-1-lf-text-liquidated-asset">4. $DV_{\text{repaid asset}} = min(RV_{\text{repaid asset}}, min(DV_{\text{repaid asset}}, \frac{CV_{\text{liquidated asset}}}{1 + LF_{\text{liquidated asset}}})$</h4>
<p>This is when the amount of debt to be repaid isn't enough to bring HF back to 1 because the user has multiple assets in debt, and this amount is smaller than the collateral that can be captured.</p>
<table><thead><tr><th></th><th>TON</th><th>USDT</th></tr></thead><tbody>
<tr><td>Collateral factor (liquidation threshold)</td><td>80%</td><td>85%</td></tr>
<tr><td>Deposited amount in USD</td><td>5.4 USD</td><td>0.1 USD</td></tr>
<tr><td>Borrowed amount in USD</td><td>2.5 USD</td><td>2.6 USD</td></tr>
<tr><td>Liquidation bonus</td><td>6%</td><td>7%</td></tr>
</tbody></table>
<p>Again, we are repaying USDT and liquidating TON:</p>
<p>$$
RV_{\text{USDT}} = \frac{-(1)(2.5 + 2.6) + (0.8 \times 5.4 + 0.85 \times 0.1)}{((0.8)(1 + 0.06)) - 1}
$$</p>
<p>$$
= 4.57236842105263...
$$</p>
<p>This means we want to liquidate 4.57236842105263 USD equivalent of USDT, but we cannot because the user only has 2.6 USD worth of USDT in debt, thus:</p>
<p>$$
\text{Final repaid amount}_{USDT} = min(4.57236842105263, min(2.6, \frac{5.4}{1.06}))
$$</p>
<p>$$
= 2.6
$$</p>
<p>This won't recover HF back to 1. It will require another liquidation to be run to repay TON and liquidate TON.</p>
<h2 id="describing-the-behavior-in-code">Describing the behavior in code</h2>
<p>The entire codebase is available on <a href="https://github.com/9oelM/defi-lending-liquidation/">github.com/9oelM/defi-lending-liquidation</a>. If we were to describe the calculation in code, it would look like this. This can actually be useful if you want to scaffold your off-chain liquidation logic:</p>
<pre data-lang="ts" style="background-color:#2b303b;color:#c0c5ce;" class="language-ts "><code class="language-ts" data-lang="ts"><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">assert</span><span>(</span><span style="color:#bf616a;">condition</span><span>: boolean, </span><span style="color:#bf616a;">message</span><span>: string) {
</span><span>    </span><span style="color:#b48ead;">if </span><span>(!</span><span style="color:#bf616a;">condition</span><span>) {
</span><span>        </span><span style="color:#b48ead;">throw </span><span>new Error(</span><span style="color:#bf616a;">message</span><span>);
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#b48ead;">export class </span><span style="color:#ebcb8b;">ScMath </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public static </span><span style="color:#bf616a;">SCALE </span><span>= </span><span style="color:#d08770;">1000000000000000000000000000</span><span style="color:#b48ead;">n</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// This function assumes `b` is scaled by `SCALE`
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">static </span><span style="color:#8fa1b3;">bigint_mul</span><span>(</span><span style="color:#bf616a;">a</span><span>: </span><span style="color:#eff1f5;">bigint, </span><span style="color:#bf616a;">b</span><span>: </span><span style="color:#eff1f5;">bigint</span><span>): </span><span style="color:#eff1f5;">bigint {
</span><span style="color:#eff1f5;">        </span><span style="color:#8fa1b3;">assert</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">a </span><span>&gt;= </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">, </span><span>&#39;</span><span style="color:#a3be8c;">a must be gte 0</span><span>&#39;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        </span><span style="color:#8fa1b3;">assert</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">b </span><span>&gt;= </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">, </span><span>&#39;</span><span style="color:#a3be8c;">b must be gte 0</span><span>&#39;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">scaled_product </span><span>= </span><span style="color:#bf616a;">a </span><span>* </span><span style="color:#bf616a;">b</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">result </span><span>= </span><span style="color:#bf616a;">scaled_product </span><span>/ </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">SCALE</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">result</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// This function assumes `b` is scaled by `SCALE`
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">static </span><span style="color:#8fa1b3;">bigint_div</span><span>(</span><span style="color:#bf616a;">a</span><span>: </span><span style="color:#eff1f5;">bigint, </span><span style="color:#bf616a;">b</span><span>: </span><span style="color:#eff1f5;">bigint</span><span>): </span><span style="color:#eff1f5;">bigint {
</span><span style="color:#eff1f5;">      </span><span style="color:#8fa1b3;">assert</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">a </span><span>&gt;= </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">, </span><span>&#39;</span><span style="color:#a3be8c;">a must be gte 0</span><span>&#39;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">      </span><span style="color:#8fa1b3;">assert</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">b </span><span>&gt;= </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">, </span><span>&#39;</span><span style="color:#a3be8c;">b must be gte 0</span><span>&#39;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">scaled_product </span><span>= </span><span style="color:#bf616a;">a </span><span>* </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">SCALE</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">result </span><span>= </span><span style="color:#bf616a;">scaled_product </span><span>/ </span><span style="color:#bf616a;">b</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">result</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">  }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">  </span><span style="color:#b48ead;">static </span><span style="color:#8fa1b3;">uint_scale_pct</span><span>(</span><span style="color:#bf616a;">pct</span><span>: </span><span style="color:#eff1f5;">bigint</span><span>) </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">      </span><span style="color:#8fa1b3;">assert</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">pct </span><span>&gt;= </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">, </span><span>&#39;</span><span style="color:#a3be8c;">pct must be gte 0</span><span>&#39;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">      </span><span style="color:#8fa1b3;">assert</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">pct </span><span>&lt;= </span><span style="color:#d08770;">100</span><span style="color:#eff1f5;">, </span><span>&#39;</span><span style="color:#a3be8c;">pct must be less than or equal to 100</span><span>&#39;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">      </span><span style="color:#b48ead;">return </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">pct </span><span>* </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">SCALE</span><span style="color:#eff1f5;">) </span><span>/ </span><span style="color:#d08770;">100</span><span style="color:#b48ead;">n</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">  }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">  </span><span style="color:#b48ead;">static </span><span style="color:#8fa1b3;">bigint_min</span><span>(...</span><span style="color:#bf616a;">args</span><span>: </span><span style="color:#eff1f5;">bigint[]</span><span>): </span><span style="color:#eff1f5;">bigint {
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">args</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">reduce</span><span style="color:#eff1f5;">(</span><span>(</span><span style="color:#bf616a;">min</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">current</span><span>) </span><span style="color:#b48ead;">=&gt; </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">current </span><span>&lt; </span><span style="color:#bf616a;">min </span><span>? </span><span style="color:#bf616a;">current </span><span>: </span><span style="color:#bf616a;">min</span><span style="color:#eff1f5;">), </span><span style="color:#bf616a;">args</span><span style="color:#eff1f5;">[</span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">]);
</span><span style="color:#eff1f5;">  }
</span><span style="color:#eff1f5;">}
</span><span>
</span><span style="color:#b48ead;">export type </span><span>CalcRepaidValueParams = {
</span><span>    </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">     * 0 &lt;= target_hf_pct &lt; 100
</span><span style="color:#65737e;">     * (usually very close to 1)
</span><span style="color:#65737e;">     */
</span><span>    </span><span style="color:#bf616a;">target_hf_pct</span><span>: bigint;
</span><span>    </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">     * will be in whatever the number of decimal places USD is in
</span><span style="color:#65737e;">     */
</span><span>    </span><span style="color:#bf616a;">native_usd_sum_of_debts_without_borrow_factors</span><span>: bigint;
</span><span>    </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">     * will be in whatever the number of decimal places USD is in
</span><span style="color:#65737e;">     */
</span><span>    </span><span style="color:#bf616a;">native_usd_sum_of_collaterals_with_collateral_factors</span><span>: bigint;
</span><span>    </span><span style="color:#bf616a;">liquidated_reserve</span><span>: {
</span><span>        </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">         * 0 &lt;= native_collateral_factor &lt; 100n
</span><span style="color:#65737e;">         */
</span><span>        </span><span style="color:#bf616a;">native_collateral_factor_pct</span><span>: bigint;
</span><span>        </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">         * 0 &lt;= native_collateral_factor &lt; 100n
</span><span style="color:#65737e;">         */
</span><span>        </span><span style="color:#bf616a;">native_liquidation_bonus_factor_pct</span><span>: bigint;
</span><span>    };
</span><span>    </span><span style="color:#bf616a;">allow_out_of_boundary_hf_for_test</span><span>?: boolean;
</span><span>};
</span><span>
</span><span style="color:#b48ead;">export type </span><span>CalcMaxLiquidableValueParams = {
</span><span>    </span><span style="color:#bf616a;">repaid_reserve</span><span>: {
</span><span>        </span><span style="color:#bf616a;">repaid_value_native_usd</span><span>: bigint;
</span><span>        </span><span style="color:#bf616a;">debt_value_native_usd</span><span>: bigint;
</span><span>    };
</span><span>    </span><span style="color:#bf616a;">liquidated_reserve</span><span>: {
</span><span>        </span><span style="color:#bf616a;">collateral_value_native_usd</span><span>: bigint;
</span><span>        </span><span style="color:#bf616a;">liquidation_bonus_factor_pct</span><span>: bigint;
</span><span>    };
</span><span>};
</span><span>
</span><span style="color:#b48ead;">export enum </span><span>MaxLiquidableReason {
</span><span>    </span><span style="color:#bf616a;">RepaidValue </span><span>= `</span><span style="color:#a3be8c;">RepaidValue</span><span>`,
</span><span>    </span><span style="color:#bf616a;">DebtValue </span><span>= `</span><span style="color:#a3be8c;">DebtValue</span><span>`,
</span><span>    </span><span style="color:#bf616a;">CollateralValue </span><span>= `</span><span style="color:#a3be8c;">CollateralValue</span><span>`,
</span><span>}
</span><span>
</span><span style="color:#b48ead;">export class </span><span style="color:#ebcb8b;">Liquidation </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">     * Calculates the amount that can be repaid for a given liquidation
</span><span style="color:#65737e;">     * where `target_hf_pct` is the target health factor percentage.
</span><span style="color:#65737e;">     *
</span><span style="color:#65737e;">     * RV_repaid_asset =
</span><span style="color:#65737e;">     * (-target_hf * ΣDV_repaid_asset + Σ(CF_liquidated_asset_i * CV_liquidated_asset_i))
</span><span style="color:#65737e;">     * / (CF_liquidated_asset * (1 + LF_liquidated_asset) - target_hf)
</span><span style="color:#65737e;">     *
</span><span style="color:#65737e;">     * </span><span style="color:#b48ead;">@returns</span><span style="color:#65737e;"> the value in native usd scale that can recover the health factor back to `target_hf_pct`.
</span><span style="color:#65737e;">     * The value needs to be fed into `calc_max_liquidable_value` again to calculate the final liquidable value.
</span><span style="color:#65737e;">     */
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">static </span><span style="color:#8fa1b3;">calc_repaid_value</span><span>(</span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">        </span><span style="color:#bf616a;">target_hf_pct</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">        </span><span style="color:#bf616a;">native_usd_sum_of_debts_without_borrow_factors</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">        </span><span style="color:#bf616a;">native_usd_sum_of_collaterals_with_collateral_factors</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">        </span><span style="color:#bf616a;">liquidated_reserve</span><span style="color:#eff1f5;">: { </span><span style="color:#bf616a;">native_collateral_factor_pct</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">native_liquidation_bonus_factor_pct </span><span style="color:#eff1f5;">},
</span><span style="color:#eff1f5;">        </span><span style="color:#bf616a;">allow_out_of_boundary_hf_for_test </span><span>= </span><span style="color:#d08770;">false</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">    }</span><span>: </span><span style="color:#eff1f5;">CalcRepaidValueParams</span><span>) </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span>!</span><span style="color:#bf616a;">allow_out_of_boundary_hf_for_test </span><span>&amp;&amp; </span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">n </span><span>&gt; </span><span style="color:#bf616a;">target_hf_pct </span><span>|| </span><span style="color:#bf616a;">target_hf_pct </span><span>&gt;= </span><span style="color:#d08770;">100</span><span style="color:#b48ead;">n</span><span style="color:#eff1f5;">)) {
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">throw </span><span>new </span><span style="color:#eff1f5;">Error(</span><span>&#39;</span><span style="color:#a3be8c;">target_hf_pct must be between 0 and 100</span><span>&#39;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">n </span><span>&gt; </span><span style="color:#bf616a;">native_collateral_factor_pct </span><span>|| </span><span style="color:#bf616a;">native_collateral_factor_pct </span><span>&gt;= </span><span style="color:#d08770;">100</span><span style="color:#b48ead;">n</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">throw </span><span>new </span><span style="color:#eff1f5;">Error(</span><span>&#39;</span><span style="color:#a3be8c;">native_collateral_factor_pct must be between 0 and 100</span><span>&#39;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">0</span><span style="color:#b48ead;">n </span><span>&gt; </span><span style="color:#bf616a;">native_liquidation_bonus_factor_pct </span><span>|| </span><span style="color:#bf616a;">native_liquidation_bonus_factor_pct </span><span>&gt;= </span><span style="color:#d08770;">100</span><span style="color:#b48ead;">n</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">throw </span><span>new </span><span style="color:#eff1f5;">Error(</span><span>&#39;</span><span style="color:#a3be8c;">native_liquidation_bonus_factor_pct must be between 0 and 100</span><span>&#39;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">native_usd_sum_of_debts_without_borrow_factors </span><span>&lt;= </span><span style="color:#d08770;">0</span><span style="color:#b48ead;">n</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">throw </span><span>new </span><span style="color:#eff1f5;">Error(</span><span>&#39;</span><span style="color:#a3be8c;">native_usd_sum_of_debts_without_borrow_factors must be greater than 0</span><span>&#39;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">native_usd_sum_of_collaterals_with_collateral_factors </span><span>&lt;= </span><span style="color:#d08770;">0</span><span style="color:#b48ead;">n</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">throw </span><span>new </span><span style="color:#eff1f5;">Error(</span><span>&#39;</span><span style="color:#a3be8c;">native_usd_sum_of_collaterals_with_collateral_factors must be greater than 0</span><span>&#39;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">scaled_target_hf_pct </span><span>= </span><span style="color:#bf616a;">ScMath</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">uint_scale_pct</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">target_hf_pct</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">scaled_liquidated_reserve </span><span>= </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">            collateral_factor: </span><span style="color:#bf616a;">ScMath</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">uint_scale_pct</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">native_collateral_factor_pct</span><span style="color:#eff1f5;">),
</span><span style="color:#eff1f5;">            liquidation_bonus_factor: </span><span style="color:#bf616a;">ScMath</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">uint_scale_pct</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">native_liquidation_bonus_factor_pct</span><span style="color:#eff1f5;">),
</span><span style="color:#eff1f5;">        };
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">// unit: USD
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">numerator </span><span>=
</span><span style="color:#eff1f5;">            </span><span style="color:#bf616a;">ScMath</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">bigint_mul</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">native_usd_sum_of_debts_without_borrow_factors</span><span style="color:#eff1f5;">, </span><span>-</span><span style="color:#bf616a;">scaled_target_hf_pct</span><span style="color:#eff1f5;">) </span><span>+
</span><span style="color:#eff1f5;">            </span><span style="color:#bf616a;">native_usd_sum_of_collaterals_with_collateral_factors</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">// unit: ScMath.SCALE
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">denominator </span><span>=
</span><span style="color:#eff1f5;">            </span><span style="color:#bf616a;">ScMath</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">bigint_mul</span><span style="color:#eff1f5;">(
</span><span style="color:#eff1f5;">                </span><span style="color:#bf616a;">scaled_liquidated_reserve</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">collateral_factor</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">                </span><span style="color:#bf616a;">ScMath</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">SCALE </span><span>+ </span><span style="color:#bf616a;">scaled_liquidated_reserve</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">liquidation_bonus_factor</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">            ) </span><span>- </span><span style="color:#bf616a;">scaled_target_hf_pct</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">// unit: USD
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">rv_repaid_asset </span><span>= </span><span style="color:#bf616a;">ScMath</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">bigint_div</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">numerator</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">denominator</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">// will need to adjust to the native scale of the asset by dividing or multiplying by the number of decimal places
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">rv_repaid_asset</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">     * min(RV_repaid_asset, min(DV_repaid_asset, (CV_liquidated_asset / (1 + LF_liquidated_asset))))
</span><span style="color:#65737e;">     * Sometimes, it wouldn&#39;t be possible to pay back all of RV_repaid_asset due to specific reasons.
</span><span style="color:#65737e;">     * Calculates the maximum liquidable value.
</span><span style="color:#65737e;">     *
</span><span style="color:#65737e;">     * Returned value is in native usd scale.
</span><span style="color:#65737e;">     */
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">static </span><span style="color:#8fa1b3;">calc_max_liquidable_value</span><span>(</span><span style="color:#eff1f5;">{ </span><span style="color:#bf616a;">repaid_reserve</span><span style="color:#eff1f5;">, </span><span style="color:#bf616a;">liquidated_reserve </span><span style="color:#eff1f5;">}</span><span>: </span><span style="color:#eff1f5;">CalcMaxLiquidableValueParams</span><span>) </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">cv_liquidated_asset </span><span>= </span><span style="color:#bf616a;">liquidated_reserve</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">collateral_value_native_usd</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">scaled_lf_liquidated_asset_pct </span><span>= </span><span style="color:#bf616a;">ScMath</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">uint_scale_pct</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">liquidated_reserve</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">liquidation_bonus_factor_pct</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">max_caputurable_collateral_native_usd </span><span>= </span><span style="color:#bf616a;">ScMath</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">bigint_div</span><span style="color:#eff1f5;">(
</span><span style="color:#eff1f5;">            </span><span style="color:#bf616a;">cv_liquidated_asset</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">            </span><span style="color:#bf616a;">ScMath</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">SCALE </span><span>+ </span><span style="color:#bf616a;">scaled_lf_liquidated_asset_pct</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">        );
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">max_liquidable_value </span><span>= </span><span style="color:#bf616a;">Liquidation</span><span style="color:#eff1f5;">.</span><span style="color:#8fa1b3;">bigint_min</span><span style="color:#eff1f5;">(
</span><span style="color:#eff1f5;">            </span><span style="color:#bf616a;">repaid_reserve</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">repaid_value_native_usd</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">            </span><span style="color:#bf616a;">repaid_reserve</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">debt_value_native_usd</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">            </span><span style="color:#bf616a;">max_caputurable_collateral_native_usd</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">        );
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">max_liquidable_value </span><span>== </span><span style="color:#bf616a;">repaid_reserve</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">repaid_value_native_usd</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">return </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">                value: </span><span style="color:#bf616a;">max_liquidable_value</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">                reason: </span><span style="color:#bf616a;">MaxLiquidableReason</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">RepaidValue</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">            };
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">max_liquidable_value </span><span>== </span><span style="color:#bf616a;">repaid_reserve</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">debt_value_native_usd</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">return </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">                value: </span><span style="color:#bf616a;">max_liquidable_value</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">                reason: </span><span style="color:#bf616a;">MaxLiquidableReason</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">DebtValue</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">            };
</span><span style="color:#eff1f5;">        }
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">            value: </span><span style="color:#bf616a;">max_liquidable_value</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">            reason: </span><span style="color:#bf616a;">MaxLiquidableReason</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">CollateralValue</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">        };
</span><span style="color:#eff1f5;">    }
</span><span style="color:#eff1f5;">}
</span></code></pre>
<p>And I've written some test cases that should tell how <code>Liquidation</code> class should be used:</p>
<pre data-lang="ts" style="background-color:#2b303b;color:#c0c5ce;" class="language-ts "><code class="language-ts" data-lang="ts"><span style="color:#b48ead;">import </span><span>{ </span><span style="color:#bf616a;">ScMath</span><span>, </span><span style="color:#bf616a;">Liquidation</span><span>, </span><span style="color:#bf616a;">MaxLiquidableReason </span><span>} </span><span style="color:#b48ead;">from </span><span>&#39;</span><span style="color:#a3be8c;">./liquidation</span><span>&#39;;
</span><span>
</span><span style="color:#b48ead;">type </span><span>LiquidationParams = {
</span><span>    </span><span style="color:#bf616a;">collateral_factor_pct</span><span>: bigint;
</span><span>    </span><span style="color:#bf616a;">deposit_native_usd</span><span>: bigint;
</span><span>    </span><span style="color:#bf616a;">debt_native_usd</span><span>: bigint;
</span><span>    </span><span style="color:#bf616a;">liquidation_bonus_pct</span><span>: bigint;
</span><span>};
</span><span>
</span><span style="color:#8fa1b3;">describe</span><span>(`</span><span style="color:#a3be8c;">sdk: liquidation</span><span>`, () </span><span style="color:#b48ead;">=&gt; </span><span>{
</span><span>    </span><span style="color:#8fa1b3;">it</span><span>(`</span><span style="color:#a3be8c;">should give correct rv_repaid_asset</span><span>`, </span><span style="color:#b48ead;">async </span><span>() </span><span style="color:#b48ead;">=&gt; </span><span>{
</span><span>        </span><span style="color:#65737e;">//                                           TON	USDT
</span><span>        </span><span style="color:#65737e;">// Collateral factor (liquidation threshold)	80%	85%
</span><span>        </span><span style="color:#65737e;">// Deposited amount in USD	                  5.4 USD	0.1 USD
</span><span>        </span><span style="color:#65737e;">// Borrowed amount in USD	                    2.5 USD	2.6 USD
</span><span>        </span><span style="color:#65737e;">// Liquidation bonus	                        6%	7%
</span><span>        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">liquidationParams</span><span>: {
</span><span>            </span><span style="color:#bf616a;">TON</span><span>: LiquidationParams;
</span><span>            </span><span style="color:#bf616a;">USDT</span><span>: LiquidationParams;
</span><span>        } = {
</span><span>            TON: {
</span><span>                collateral_factor_pct: </span><span style="color:#d08770;">80</span><span style="color:#b48ead;">n</span><span>,
</span><span>                deposit_native_usd: </span><span style="color:#d08770;">540_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                debt_native_usd: </span><span style="color:#d08770;">250_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                liquidation_bonus_pct: </span><span style="color:#d08770;">6</span><span style="color:#b48ead;">n</span><span>,
</span><span>            },
</span><span>            USDT: {
</span><span>                collateral_factor_pct: </span><span style="color:#d08770;">85</span><span style="color:#b48ead;">n</span><span>,
</span><span>                deposit_native_usd: </span><span style="color:#d08770;">10_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                debt_native_usd: </span><span style="color:#d08770;">260_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                liquidation_bonus_pct: </span><span style="color:#d08770;">7</span><span style="color:#b48ead;">n</span><span>,
</span><span>            },
</span><span>        };
</span><span>        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">native_usd_sum_of_collaterals_with_collateral_factors </span><span>=
</span><span>            </span><span style="color:#bf616a;">ScMath</span><span>.</span><span style="color:#8fa1b3;">bigint_mul</span><span>(
</span><span>                </span><span style="color:#bf616a;">liquidationParams</span><span>.</span><span style="color:#bf616a;">TON</span><span>.</span><span style="color:#bf616a;">deposit_native_usd</span><span>,
</span><span>                </span><span style="color:#bf616a;">ScMath</span><span>.</span><span style="color:#8fa1b3;">uint_scale_pct</span><span>(</span><span style="color:#bf616a;">liquidationParams</span><span>.</span><span style="color:#bf616a;">TON</span><span>.</span><span style="color:#bf616a;">collateral_factor_pct</span><span>),
</span><span>            ) +
</span><span>            </span><span style="color:#bf616a;">ScMath</span><span>.</span><span style="color:#8fa1b3;">bigint_mul</span><span>(
</span><span>                </span><span style="color:#bf616a;">liquidationParams</span><span>.</span><span style="color:#bf616a;">USDT</span><span>.</span><span style="color:#bf616a;">deposit_native_usd</span><span>,
</span><span>                </span><span style="color:#bf616a;">ScMath</span><span>.</span><span style="color:#8fa1b3;">uint_scale_pct</span><span>(</span><span style="color:#bf616a;">liquidationParams</span><span>.</span><span style="color:#bf616a;">USDT</span><span>.</span><span style="color:#bf616a;">collateral_factor_pct</span><span>),
</span><span>            );
</span><span>
</span><span>        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">rv_usdt </span><span>= </span><span style="color:#bf616a;">Liquidation</span><span>.</span><span style="color:#8fa1b3;">calc_repaid_value</span><span>({
</span><span>            target_hf_pct: </span><span style="color:#d08770;">99</span><span style="color:#b48ead;">n</span><span>, </span><span style="color:#65737e;">// recover back to HF = 99%
</span><span>            native_usd_sum_of_debts_without_borrow_factors:
</span><span>                </span><span style="color:#bf616a;">liquidationParams</span><span>.</span><span style="color:#bf616a;">TON</span><span>.</span><span style="color:#bf616a;">debt_native_usd </span><span>+ </span><span style="color:#bf616a;">liquidationParams</span><span>.</span><span style="color:#bf616a;">USDT</span><span>.</span><span style="color:#bf616a;">debt_native_usd</span><span>,
</span><span>            </span><span style="color:#bf616a;">native_usd_sum_of_collaterals_with_collateral_factors</span><span>,
</span><span>            liquidated_reserve: {
</span><span>                native_collateral_factor_pct: </span><span style="color:#bf616a;">liquidationParams</span><span>.</span><span style="color:#bf616a;">TON</span><span>.</span><span style="color:#bf616a;">collateral_factor_pct</span><span>,
</span><span>                native_liquidation_bonus_factor_pct: </span><span style="color:#bf616a;">liquidationParams</span><span>.</span><span style="color:#bf616a;">TON</span><span>.</span><span style="color:#bf616a;">liquidation_bonus_pct</span><span>,
</span><span>            },
</span><span>        });
</span><span>
</span><span>        </span><span style="color:#65737e;">// 4.57236842 USD
</span><span>        </span><span style="color:#8fa1b3;">expect</span><span>(</span><span style="color:#d08770;">453521126</span><span style="color:#b48ead;">n</span><span>).</span><span style="color:#8fa1b3;">toEqual</span><span>(</span><span style="color:#bf616a;">rv_usdt</span><span>);
</span><span>    });
</span><span>
</span><span>    </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">TARGET_HF </span><span>= </span><span style="color:#d08770;">99</span><span style="color:#b48ead;">n</span><span>; </span><span style="color:#65737e;">// recover back to HF = 0.99
</span><span>
</span><span>    </span><span style="color:#bf616a;">it</span><span>.</span><span style="color:#8fa1b3;">each</span><span>([
</span><span>        </span><span style="color:#65737e;">//                                            TON	USDT
</span><span>        </span><span style="color:#65737e;">// Collateral factor (liquidation threshold)	80%	85%
</span><span>        </span><span style="color:#65737e;">// Deposited amount in USD	                  5.4 USD	0.1 USD
</span><span>        </span><span style="color:#65737e;">// Borrowed amount in USD	                    0.1 USD	5 USD
</span><span>        </span><span style="color:#65737e;">// Liquidation bonus	                        6%	7%
</span><span>        {
</span><span>            params: {
</span><span>                TON: {
</span><span>                    collateral_factor_pct: </span><span style="color:#d08770;">80</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    </span><span style="color:#65737e;">// 5.4
</span><span>                    deposit_native_usd: </span><span style="color:#d08770;">540_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    </span><span style="color:#65737e;">// 0.1
</span><span>                    debt_native_usd: </span><span style="color:#d08770;">10_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    liquidation_bonus_pct: </span><span style="color:#d08770;">6</span><span style="color:#b48ead;">n</span><span>,
</span><span>                },
</span><span>                USDT: {
</span><span>                    collateral_factor_pct: </span><span style="color:#d08770;">85</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    </span><span style="color:#65737e;">// 0.1
</span><span>                    deposit_native_usd: </span><span style="color:#d08770;">10_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    </span><span style="color:#65737e;">// 5
</span><span>                    debt_native_usd: </span><span style="color:#d08770;">500_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    liquidation_bonus_pct: </span><span style="color:#d08770;">7</span><span style="color:#b48ead;">n</span><span>,
</span><span>                },
</span><span>            },
</span><span>            </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">             * (−(0.99)(5+0.1)+(0.8×5.4+0.85×0.1))/((0.8)(1 + 0.06) - 0.99) = 4.53521126 USD
</span><span style="color:#65737e;">             */
</span><span>            rv: </span><span style="color:#d08770;">453521126</span><span style="color:#b48ead;">n</span><span>,
</span><span>            </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">             * min(4.53521126, 5, 5.4 / 1.06)
</span><span style="color:#65737e;">             */
</span><span>            maxLiquidable: {
</span><span>                reason: </span><span style="color:#bf616a;">MaxLiquidableReason</span><span>.</span><span style="color:#bf616a;">RepaidValue</span><span>,
</span><span>                value: </span><span style="color:#d08770;">453521126</span><span style="color:#b48ead;">n</span><span>,
</span><span>            },
</span><span>        },
</span><span>        </span><span style="color:#65737e;">//                                            TON	USDT
</span><span>        </span><span style="color:#65737e;">// Collateral factor (liquidation threshold)	80%	85%
</span><span>        </span><span style="color:#65737e;">// Deposited amount in USD	                  3 USD	2.5 USD
</span><span>        </span><span style="color:#65737e;">// Borrowed amount in USD	                    0.1 USD	5 USD
</span><span>        </span><span style="color:#65737e;">// Liquidation bonus                        	6%	7%
</span><span>        {
</span><span>            params: {
</span><span>                TON: {
</span><span>                    collateral_factor_pct: </span><span style="color:#d08770;">80</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    </span><span style="color:#65737e;">// 3
</span><span>                    deposit_native_usd: </span><span style="color:#d08770;">300_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    </span><span style="color:#65737e;">// 0.1
</span><span>                    debt_native_usd: </span><span style="color:#d08770;">10_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    liquidation_bonus_pct: </span><span style="color:#d08770;">6</span><span style="color:#b48ead;">n</span><span>,
</span><span>                },
</span><span>                USDT: {
</span><span>                    collateral_factor_pct: </span><span style="color:#d08770;">85</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    </span><span style="color:#65737e;">// 2.5
</span><span>                    deposit_native_usd: </span><span style="color:#d08770;">250_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    </span><span style="color:#65737e;">// 5
</span><span>                    debt_native_usd: </span><span style="color:#d08770;">500_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    liquidation_bonus_pct: </span><span style="color:#d08770;">7</span><span style="color:#b48ead;">n</span><span>,
</span><span>                },
</span><span>            },
</span><span>            </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">             * ((−(0.99)(5+0.1))+(0.8×3+0.85×2.5))/(0.8(1 + 0.06) - 0.99) = 3.69014084 USD
</span><span style="color:#65737e;">             */
</span><span>            rv: </span><span style="color:#d08770;">369014084</span><span style="color:#b48ead;">n</span><span>,
</span><span>            maxLiquidable: {
</span><span>                reason: </span><span style="color:#bf616a;">MaxLiquidableReason</span><span>.</span><span style="color:#bf616a;">CollateralValue</span><span>,
</span><span>                </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">                 * min(3.69014084, 5, 3 / 1.06)
</span><span style="color:#65737e;">                 *
</span><span style="color:#65737e;">                 * CV_liquidated_asset / (1 + LF_liquidated_asset) =
</span><span style="color:#65737e;">                 * 3 / (1 + 0.06) = 2.830188679245283
</span><span style="color:#65737e;">                 */
</span><span>                value: </span><span style="color:#d08770;">2_83018867</span><span style="color:#b48ead;">n</span><span>,
</span><span>            },
</span><span>        },
</span><span>        </span><span style="color:#65737e;">//                                            TON	USDT
</span><span>        </span><span style="color:#65737e;">// Collateral factor (liquidation threshold)	80%	85%
</span><span>        </span><span style="color:#65737e;">// Deposited amount in USD	                  5.4 USD	0.1 USD
</span><span>        </span><span style="color:#65737e;">// Borrowed amount in USD	                    2.5 USD	2.6 USD
</span><span>        </span><span style="color:#65737e;">// Liquidation bonus	                        6%	7%
</span><span>        {
</span><span>            params: {
</span><span>                TON: {
</span><span>                    collateral_factor_pct: </span><span style="color:#d08770;">80</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    </span><span style="color:#65737e;">// 5.4
</span><span>                    deposit_native_usd: </span><span style="color:#d08770;">540_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    </span><span style="color:#65737e;">// 2.5
</span><span>                    debt_native_usd: </span><span style="color:#d08770;">250_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    liquidation_bonus_pct: </span><span style="color:#d08770;">6</span><span style="color:#b48ead;">n</span><span>,
</span><span>                },
</span><span>                USDT: {
</span><span>                    collateral_factor_pct: </span><span style="color:#d08770;">85</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    </span><span style="color:#65737e;">// 0.1
</span><span>                    deposit_native_usd: </span><span style="color:#d08770;">10_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    </span><span style="color:#65737e;">// 2.6
</span><span>                    debt_native_usd: </span><span style="color:#d08770;">260_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>                    liquidation_bonus_pct: </span><span style="color:#d08770;">7</span><span style="color:#b48ead;">n</span><span>,
</span><span>                },
</span><span>            },
</span><span>            </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">             * ((−(0.99)(2.5+2.6))+(0.8×5.4+0.85×0.1))/(0.8(1 + 0.06) - 0.99) = 4.53521126 USD
</span><span style="color:#65737e;">             * 4.53521126 USD
</span><span style="color:#65737e;">             */
</span><span>            rv: </span><span style="color:#d08770;">453521126</span><span style="color:#b48ead;">n</span><span>,
</span><span>            </span><span style="color:#65737e;">/**
</span><span style="color:#65737e;">             * min(4.53521126, 2.6, 5.4 / 1.06)
</span><span style="color:#65737e;">             */
</span><span>            maxLiquidable: {
</span><span>                reason: </span><span style="color:#bf616a;">MaxLiquidableReason</span><span>.</span><span style="color:#bf616a;">DebtValue</span><span>,
</span><span>                value: </span><span style="color:#d08770;">260_000_000</span><span style="color:#b48ead;">n</span><span>,
</span><span>            },
</span><span>        },
</span><span>    ])(`</span><span style="color:#a3be8c;">should give correct max liquidable value: $maxLiquidable</span><span>`, ({ </span><span style="color:#bf616a;">params</span><span>, </span><span style="color:#bf616a;">rv</span><span>, </span><span style="color:#bf616a;">maxLiquidable </span><span>}) </span><span style="color:#b48ead;">=&gt; </span><span>{
</span><span>        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">native_usd_sum_of_collaterals_with_collateral_factors </span><span>=
</span><span>            </span><span style="color:#bf616a;">ScMath</span><span>.</span><span style="color:#8fa1b3;">bigint_mul</span><span>(</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">TON</span><span>.</span><span style="color:#bf616a;">deposit_native_usd</span><span>, </span><span style="color:#bf616a;">ScMath</span><span>.</span><span style="color:#8fa1b3;">uint_scale_pct</span><span>(</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">TON</span><span>.</span><span style="color:#bf616a;">collateral_factor_pct</span><span>)) +
</span><span>            </span><span style="color:#bf616a;">ScMath</span><span>.</span><span style="color:#8fa1b3;">bigint_mul</span><span>(</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">USDT</span><span>.</span><span style="color:#bf616a;">deposit_native_usd</span><span>, </span><span style="color:#bf616a;">ScMath</span><span>.</span><span style="color:#8fa1b3;">uint_scale_pct</span><span>(</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">USDT</span><span>.</span><span style="color:#bf616a;">collateral_factor_pct</span><span>));
</span><span>
</span><span>        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">rv_usdt </span><span>= </span><span style="color:#bf616a;">Liquidation</span><span>.</span><span style="color:#8fa1b3;">calc_repaid_value</span><span>({
</span><span>            target_hf_pct: </span><span style="color:#bf616a;">TARGET_HF</span><span>,
</span><span>            native_usd_sum_of_debts_without_borrow_factors: </span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">TON</span><span>.</span><span style="color:#bf616a;">debt_native_usd </span><span>+ </span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">USDT</span><span>.</span><span style="color:#bf616a;">debt_native_usd</span><span>,
</span><span>            </span><span style="color:#bf616a;">native_usd_sum_of_collaterals_with_collateral_factors</span><span>,
</span><span>            liquidated_reserve: {
</span><span>                native_collateral_factor_pct: </span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">TON</span><span>.</span><span style="color:#bf616a;">collateral_factor_pct</span><span>,
</span><span>                native_liquidation_bonus_factor_pct: </span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">TON</span><span>.</span><span style="color:#bf616a;">liquidation_bonus_pct</span><span>,
</span><span>            },
</span><span>        });
</span><span>
</span><span>        </span><span style="color:#8fa1b3;">expect</span><span>(</span><span style="color:#bf616a;">rv_usdt</span><span>).</span><span style="color:#8fa1b3;">toBe</span><span>(</span><span style="color:#bf616a;">rv</span><span>);
</span><span>
</span><span>        </span><span style="color:#b48ead;">const </span><span style="color:#bf616a;">max_liquidable </span><span>= </span><span style="color:#bf616a;">Liquidation</span><span>.</span><span style="color:#8fa1b3;">calc_max_liquidable_value</span><span>({
</span><span>            repaid_reserve: {
</span><span>                repaid_value_native_usd: </span><span style="color:#bf616a;">rv_usdt</span><span>,
</span><span>                debt_value_native_usd: </span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">USDT</span><span>.</span><span style="color:#bf616a;">debt_native_usd</span><span>,
</span><span>            },
</span><span>            liquidated_reserve: {
</span><span>                collateral_value_native_usd: </span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">TON</span><span>.</span><span style="color:#bf616a;">deposit_native_usd</span><span>,
</span><span>                liquidation_bonus_factor_pct: </span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">TON</span><span>.</span><span style="color:#bf616a;">liquidation_bonus_pct</span><span>,
</span><span>            },
</span><span>        });
</span><span>
</span><span>        </span><span style="color:#8fa1b3;">expect</span><span>(</span><span style="color:#bf616a;">max_liquidable</span><span>).</span><span style="color:#8fa1b3;">toEqual</span><span>(</span><span style="color:#bf616a;">maxLiquidable</span><span>);
</span><span>    });
</span><span>});
</span></code></pre>
<p>That's it! It might seem like a lot when you first get started, but once you understand how we derive the equation for $RV_{\text{asset}}$, the rest will become very clear to you. Cheers and please stay in the loop for the next blockchain post. Thanks!</p>

    <h1>Comments</h1>
    <script src="https://giscus.app/client.js"
        data-repo="lazer-1/lazer-1.github.io"
        data-repo-id="R_kgDOJzlwUg"
        data-category="Comments"
        data-category-id="DIC_kwDOJzlwUs4Cevy9"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="dark"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
    </script>
</main>

    <div class="dark-mode-buttons">
        <button class="dark-mode-button" id="dark-mode-on"><img src="https://lazer1.xyz/dark_mode.svg" width="24" height="24" alt="Dark mode" aria-label="dark mode toggle" title="Dark mode"></button>
        <button class="dark-mode-button" id="dark-mode-off"><img src="https://lazer1.xyz/light_mode.svg" width="24" height="24" alt="Light mode" aria-label="light mode toggle" title="Light mode"></button>
    </div>
    <script>
        const cls = document.body.classList;
        const getSessionTheme = sessionStorage.getItem("theme");
        if (getSessionTheme === "dark") {
            cls.toggle("dark-mode", true);
        } else if (getSessionTheme === "light") {
            cls.toggle("dark-mode", false);
        } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
            cls.toggle("dark-mode", true);
        }

        document.getElementById("dark-mode-on").addEventListener("click", function(e) {
            cls.toggle("dark-mode", true);
            sessionStorage.setItem("theme", "dark");
        });
        document.getElementById("dark-mode-off").addEventListener("click", function(e) {
            cls.toggle("dark-mode", false);
            sessionStorage.setItem("theme", "light");
        });
    </script>
    <noscript>
        <style>
            .dark-mode-buttons {
                display: none;
            }
        </style>
    </noscript>
</body>
</html>
